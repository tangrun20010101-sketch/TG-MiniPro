# 抽奖系统设计文档

> 产品 + 技术规格，供开发与设计参考

---

## 素材结构

```
frontend/assets/images/lottery/
├── wheel.png          # 转盘（固定，10 等分）560×560
├── pointer.png        # 按钮外圈指针 96×96
├── draw_btn.png       # 中心抽奖按钮（圆形）
├── wheel.svg          # 转盘占位（备用）
├── pointer.svg        # 指针占位（备用）
├── draw_btn.svg       # 按钮占位（备用）
└── README.md          # 素材说明
```

**引用**：`lottery.html`、`assets.js` → `lottery.*`

---

## 一、产品概述

### 1.1 入口

- 首页「抽奖」按钮 → 进入抽奖页 `lottery.html`

### 1.2 页面结构（Figma 67-184）

| 区域 | 内容 |
|------|------|
| 标题区 | 左圆形返回、中金币+数量、右圆形设置 |
| 转盘区 | 固定转盘 + 中心金色「幸运」按钮 |
| 底部统计 | 左麒麟数量、中金币、右财神数量 |

### 1.3 消耗

- 10 金币 抽 1 次
- 90 金币 抽 10 次（送 1 次，等于 11 发）

---

## 二、交互与视觉

### 2.1 布局说明

- **转盘**：固定不转，10 等分（每档 36°）
- **按钮**：在转盘中心，用户按住
- **指针**：在按钮外圈上，随用户操作旋转

### 2.2 交互流程

1. 用户按住中心按钮
2. 记录按下时长（用于动画）
3. 用户松手 → 请求服务端 `POST /api/lottery/draw`
4. 服务端返回结果角度
5. 指针按「按下时长」作为动画时长，旋转到该角度并停止
6. 展示获得的卡牌

### 2.3 按下时长

- **不参与概率**：结果完全由服务端随机决定
- **只影响动画**：按得越久，转得越久（提升手感）

---

## 三、概率与档位

### 3.1 10 个停靠位置

| 角度 | 卡牌 | 概率 |
|------|------|------|
| 36° | 麒麟 | 1% |
| 324° | 财神 | 0.01% |
| 0°/360°、72°、108°、144°、180°、216°、252°、288° | 普通 | 各约 12.37%（8 档均分 98.99%） |

### 3.2 卡牌类型

- **麒麟**：1 档，概率 1%
- **财神**：1 档，概率 0.01%
- **普通**：8 档，统一为一种普通牌，概率均分

---

## 四、技术规格

### 4.1 API

```
POST /api/lottery/draw
Content-Type: application/json

请求体:
{
  "initData": "..."  // Telegram initData，用户身份
}

响应:
{
  "ok": true,
  "angle": 324,      // 0, 36, 72, 108, 144, 180, 216, 252, 324, 360 之一
  "cardType": "caishen"  // normal | qilin | caishen
}
```

### 4.2 服务端逻辑

1. 校验用户身份（initData）
2. 校验金币余额（10 金币/次）
3. 按概率随机选取角度：
   - 1% → 36°（麒麟）
   - 0.01% → 324°（财神）
   - 98.99% → 8 个普通档位均分
4. 扣减金币
5. 落库（用户、时间、角度、卡牌类型）
6. 返回角度

### 4.3 前端逻辑

1. 按下：记录 `pressStartTime`
2. 松手：`pressDuration = Date.now() - pressStartTime`
3. 请求 `/api/lottery/draw`
4. 动画时长 = `pressDuration`（或做 min/max 限制）
5. 指针从当前角度旋转到 `angle`，时长 `pressDuration`

---

## 五、安全与风控

- 结果由服务端决定，前端不可篡改
- 校验 initData 防匿名刷
- 频率限制（如每分钟 N 次）
- 每次抽奖前检查并扣减金币

---

## 六、数据落库（建议）

| 字段 | 说明 |
|------|------|
| user_id | 用户 ID |
| draw_time | 抽奖时间 |
| angle | 结果角度 |
| card_type | 卡牌类型 |
| coins_spent | 消耗金币 |
